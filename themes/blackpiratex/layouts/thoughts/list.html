{{ partial "header.html" . }}

<div id="post">
    <div id="wrapper">
        <article class="norm thoughts-index">
            <h2 id="title">{{ .Title }}</h2>
            <p class="thoughts-meta"><span class="thoughts-count">{{ len .Pages }}</span> thoughts</p>
            <div class="thoughts-filter">
                <label class="thoughts-filter-label" for="thoughts-date-filter">Filter by date</label>
                <div class="thoughts-filter-controls">
                    <input id="thoughts-date-filter" class="thoughts-date-input" type="date" aria-hidden="true"
                        tabindex="-1" />
                    <button type="button" class="thoughts-filter-clear" id="thoughts-filter-clear" disabled>Clear</button>
                </div>
                <div class="thoughts-calendar" id="thoughts-calendar" aria-label="Thoughts calendar">
                    <div class="thoughts-calendar-header">
                        <button type="button" class="thoughts-calendar-nav" id="thoughts-calendar-prev"
                            aria-label="Previous month">‹</button>
                        <div class="thoughts-calendar-month" id="thoughts-calendar-month"></div>
                        <button type="button" class="thoughts-calendar-nav" id="thoughts-calendar-next"
                            aria-label="Next month">›</button>
                    </div>
                    <div class="thoughts-calendar-weekdays">
                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                    </div>
                    <div class="thoughts-calendar-grid" id="thoughts-calendar-grid"></div>
                </div>
                <div class="thoughts-filter-status" id="thoughts-filter-status">Showing all thoughts</div>
            </div>
            <div class="thoughts-stats" id="thoughts-stats">
                <div class="thoughts-stats-block">
                    <div class="thoughts-stats-title">Posts by month</div>
                    <div class="thoughts-stats-list" id="thoughts-stats-months"></div>
                </div>
                <div class="thoughts-stats-block">
                    <div class="thoughts-stats-title">Posts by year</div>
                    <div class="thoughts-stats-list" id="thoughts-stats-years"></div>
                </div>
            </div>

            <div class="micro-feed">
                {{ range $index, $page := (.Paginate .Pages 100).Pages }}
                <div class="micro-item" data-thought-id="thought-{{ $index }}"
                    data-date="{{ .Date.Format "2006-01-02" }}"
                    onclick="openThoughtModal('thought-{{ $index }}')">
                    <span class="micro-dot"></span>
                    <div class="micro-header">
                        <a href="{{ .Permalink }}" class="micro-timestamp-link" onclick="event.stopPropagation()">
                            <span class="micro-date-time">
                                <span class="micro-date">{{ .Date.Format "Jan 02, 2006" }}</span>
                                <span class="micro-separator">·</span>
                                <span class="micro-time">{{ .Date.Format "15:04" }}</span>
                            </span>
                        </a>
                    </div>

                    <div class="micro-content">
                        {{ .Content }}
                    </div>

                    {{ if .Params.tags }}
                    <div class="micro-tags">
                        {{ range .Params.tags }}
                        <a class="micro-tag" href="{{ "/tags/" | relLangURL }}{{ . | urlize }}"
                            onclick="event.stopPropagation()">
                            #{{ . }}
                        </a>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>

                <!-- Hidden modal content for each thought -->
                <template id="thought-{{ $index }}-content">
                    <div class="thought-modal-date">{{ .Date.Format "January 02, 2006 · 15:04" }}</div>
                    <div class="thought-modal-body">{{ .Content }}</div>
                    {{ if .Params.tags }}
                    <div class="thought-modal-tags">
                        {{ range .Params.tags }}<span class="thought-modal-tag">#{{ . }}</span>{{ end }}
                    </div>
                    {{ end }}
                    <a href="{{ .Permalink }}" class="thought-modal-link">View full post →</a>
                </template>
                {{ end }}
            </div>
        </article>

        {{ partial "pagination.html" . }}
    </div>
</div>

<!-- Thought Modal Overlay -->
<div class="thought-modal-overlay" id="thought-modal-overlay" onclick="closeThoughtModal()">
    <div class="thought-modal" onclick="event.stopPropagation()">
        <button class="thought-modal-close" onclick="closeThoughtModal()">×</button>
        <div class="thought-modal-content" id="thought-modal-content">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<script>
    function openThoughtModal(id) {
        const template = document.getElementById(id + '-content');
        const content = document.getElementById('thought-modal-content');
        const overlay = document.getElementById('thought-modal-overlay');

        if (template && content && overlay) {
            content.innerHTML = template.innerHTML;
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeThoughtModal() {
        const overlay = document.getElementById('thought-modal-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeThoughtModal();
    });

    const tagsBaseUrl = "{{ "/tags/" | relLangURL }}";
    const allThoughts = (function () {
        {{- $all := slice -}}
        {{- range .Pages -}}
        {{- $all = $all | append (dict
        "date" (.Date.Format "2006-01-02")
        "dateLabel" (.Date.Format "Jan 02, 2006")
        "timeLabel" (.Date.Format "15:04")
        "datetimeLabel" (.Date.Format "January 02, 2006 · 15:04")
        "permalink" .Permalink
        "content" .Content
        "tags" .Params.tags
        ) -}}
        {{- end -}}
        return {{ $all | jsonify | safeJS }};
    })();

    (function () {
        const input = document.getElementById('thoughts-date-filter');
        const clearBtn = document.getElementById('thoughts-filter-clear');
        const status = document.getElementById('thoughts-filter-status');
        const feed = document.querySelector('.micro-feed');
        const initialItems = Array.from(document.querySelectorAll('.micro-item'));
        const statsMonths = document.getElementById('thoughts-stats-months');
        const statsYears = document.getElementById('thoughts-stats-years');
        const calendar = document.getElementById('thoughts-calendar');
        const calendarGrid = document.getElementById('thoughts-calendar-grid');
        const calendarMonth = document.getElementById('thoughts-calendar-month');
        const calendarPrev = document.getElementById('thoughts-calendar-prev');
        const calendarNext = document.getElementById('thoughts-calendar-next');

        if (!input || !clearBtn || !status || !feed) return;

        const normalizeTags = (tags) => Array.isArray(tags) ? tags : [];
        const availableDates = new Set(allThoughts.map((thought) => thought.date));
        const dateLabels = new Map(allThoughts.map((thought) => [thought.date, thought.dateLabel]));

        const updateStatus = (visibleCount, totalCount, dateValue) => {
            if (dateValue) {
                const label = dateLabels.get(dateValue) || dateValue;
                status.textContent = `Showing ${visibleCount} of ${totalCount} thoughts on ${label}`;
            } else {
                status.textContent = 'Showing all thoughts';
            }
        };

        const renderThoughts = (thoughts) => {
            const html = thoughts.map((thought, index) => {
                const tagHtml = normalizeTags(thought.tags).length
                    ? `<div class="micro-tags">${normalizeTags(thought.tags).map((tag) => (
                        `<a class="micro-tag" href="${tagsBaseUrl}${encodeURIComponent(tag.toLowerCase().replace(/\s+/g, '-'))}" onclick="event.stopPropagation()">#${tag}</a>`
                    )).join('')}</div>`
                    : '';
                return `
                <div class="micro-item" data-date="${thought.date}" data-thought-index="${index}">
                    <span class="micro-dot"></span>
                    <div class="micro-header">
                        <a href="${thought.permalink}" class="micro-timestamp-link" onclick="event.stopPropagation()">
                            <span class="micro-date-time">
                                <span class="micro-date">${thought.dateLabel}</span>
                                <span class="micro-separator">·</span>
                                <span class="micro-time">${thought.timeLabel}</span>
                            </span>
                        </a>
                    </div>
                    <div class="micro-content">${thought.content}</div>
                    ${tagHtml}
                </div>
                `;
            }).join('');
            feed.innerHTML = html || '<div class="thoughts-empty">No thoughts found for that date.</div>';
            bindThoughtClicks(thoughts);
        };

        const bindThoughtClicks = (thoughts) => {
            const nodes = Array.from(feed.querySelectorAll('.micro-item'));
            nodes.forEach((node, idx) => {
                node.addEventListener('click', () => {
                    const thought = thoughts[idx];
                    if (!thought) return;
                    const content = document.getElementById('thought-modal-content');
                    const overlay = document.getElementById('thought-modal-overlay');
                    if (!content || !overlay) return;
                    const tagHtml = normalizeTags(thought.tags).length
                        ? `<div class="thought-modal-tags">${normalizeTags(thought.tags).map((tag) => `<span class="thought-modal-tag">#${tag}</span>`).join('')}</div>`
                        : '';
                    content.innerHTML = `
                        <div class="thought-modal-date">${thought.datetimeLabel}</div>
                        <div class="thought-modal-body">${thought.content}</div>
                        ${tagHtml}
                        <a href="${thought.permalink}" class="thought-modal-link">View full post →</a>
                    `;
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
            });
        };

        const applyFilter = (dateValue) => {
            clearBtn.disabled = !dateValue;
            if (!dateValue) {
                initialItems.forEach((item) => {
                    item.style.display = '';
                });
                updateStatus(initialItems.length, allThoughts.length, '');
                if (feed.dataset.mode !== 'initial') {
                    feed.innerHTML = '';
                    initialItems.forEach((item) => feed.appendChild(item));
                    feed.dataset.mode = 'initial';
                }
                return;
            }
            const filtered = allThoughts.filter((thought) => thought.date === dateValue);
            updateStatus(filtered.length, allThoughts.length, dateValue);
            renderThoughts(filtered);
            feed.dataset.mode = 'filtered';
        };

        const formatMonthLabel = (year, month) => {
            const date = new Date(Date.UTC(year, month, 1));
            return date.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        };

        const renderCalendar = (year, month, selectedDate) => {
            if (!calendarGrid || !calendarMonth) return;
            calendarMonth.textContent = formatMonthLabel(year, month);
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const cells = [];
            for (let i = 0; i < startDay; i += 1) {
                cells.push('<span class="thoughts-calendar-cell is-empty"></span>');
            }
            for (let day = 1; day <= daysInMonth; day += 1) {
                const dateValue = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasPost = availableDates.has(dateValue);
                const isSelected = selectedDate === dateValue;
                const classes = [
                    'thoughts-calendar-cell',
                    hasPost ? 'has-post' : 'no-post',
                    isSelected ? 'is-selected' : ''
                ].filter(Boolean).join(' ');
                const disabled = hasPost ? '' : 'disabled';
                cells.push(
                    `<button type="button" class="${classes}" data-date="${dateValue}" ${disabled}>${day}</button>`
                );
            }
            calendarGrid.innerHTML = cells.join('');
            calendarGrid.querySelectorAll('button.has-post').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const dateValue = btn.getAttribute('data-date');
                    input.value = dateValue;
                    applyFilter(dateValue);
                    renderCalendar(year, month, dateValue);
                });
            });
        };

        let calendarYear = null;
        let calendarMonth = null;

        input.addEventListener('change', () => {
            applyFilter(input.value);
            if (calendarYear !== null && calendarMonth !== null) {
                renderCalendar(calendarYear, calendarMonth, input.value);
            }
        });

        clearBtn.addEventListener('click', () => {
            input.value = '';
            applyFilter('');
            if (calendarYear !== null && calendarMonth !== null) {
                renderCalendar(calendarYear, calendarMonth, '');
            }
        });

        const buildStats = () => {
            if (!statsMonths || !statsYears) return;
            const byMonth = new Map();
            const byYear = new Map();
            allThoughts.forEach((thought) => {
                const monthKey = thought.date.slice(0, 7);
                const yearKey = thought.date.slice(0, 4);
                byMonth.set(monthKey, (byMonth.get(monthKey) || 0) + 1);
                byYear.set(yearKey, (byYear.get(yearKey) || 0) + 1);
            });
            const monthEntries = Array.from(byMonth.entries()).sort((a, b) => b[0].localeCompare(a[0]));
            const yearEntries = Array.from(byYear.entries()).sort((a, b) => b[0].localeCompare(a[0]));
            statsMonths.innerHTML = monthEntries.map(([key, count]) => `<span class="thoughts-stat-chip">${key} · ${count}</span>`).join('');
            statsYears.innerHTML = yearEntries.map(([key, count]) => `<span class="thoughts-stat-chip">${key} · ${count}</span>`).join('');
        };

        buildStats();
        if (calendar && allThoughts.length) {
            const latestDate = allThoughts.reduce((latest, thought) => {
                return thought.date > latest ? thought.date : latest;
            }, '0000-00-00');
            const [year, month] = latestDate.split('-').map((value, idx) => idx === 1 ? Number(value) - 1 : Number(value));
            calendarYear = year;
            calendarMonth = month;
            renderCalendar(calendarYear, calendarMonth, '');
            if (calendarPrev) {
                calendarPrev.addEventListener('click', () => {
                    calendarMonth -= 1;
                    if (calendarMonth < 0) {
                        calendarMonth = 11;
                        calendarYear -= 1;
                    }
                    renderCalendar(calendarYear, calendarMonth, input.value);
                });
            }
            if (calendarNext) {
                calendarNext.addEventListener('click', () => {
                    calendarMonth += 1;
                    if (calendarMonth > 11) {
                        calendarMonth = 0;
                        calendarYear += 1;
                    }
                    renderCalendar(calendarYear, calendarMonth, input.value);
                });
            }
        }
        applyFilter('');
    })();
</script>

{{ partial "footer.html" . }}
