{{ partial "header.html" . }}

<div class="reading-progress" id="reading-progress"></div>

<div id="post" class="post-with-sidebar">
    <div id="wrapper" class="wrapper-with-sidebar">
        <!-- Sidebar TOC (Desktop only, Draggable) -->
        {{ if .TableOfContents }}
        <aside class="toc-sidebar" id="toc-sidebar">
            <div class="toc-sticky">
                <div class="toc-sidebar-header toc-drag-handle" id="toc-drag-handle">
                    <span class="toc-drag-icon" title="Drag to move">⋮⋮</span>
                    <span class="toc-title">Contents</span>
                </div>
                <nav class="toc-nav">
                    {{ .TableOfContents }}
                </nav>
            </div>
        </aside>
        <script>
            (function () {
                const sidebar = document.getElementById('toc-sidebar');
                const handle = document.getElementById('toc-drag-handle');
                if (!sidebar || !handle || window.innerWidth < 1100) return;

                let isDragging = false;
                let startX, startY, initialX, initialY;

                // Remove default positioning once user starts dragging
                function enableDragging() {
                    sidebar.style.position = 'fixed';
                    sidebar.style.transform = 'none';
                }

                handle.addEventListener('mousedown', function (e) {
                    if (window.innerWidth < 1100) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;

                    const rect = sidebar.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;

                    enableDragging();
                    sidebar.style.transition = 'none';
                    sidebar.style.cursor = 'grabbing';
                    handle.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', function (e) {
                    if (!isDragging) return;

                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    let newX = initialX + dx;
                    let newY = initialY + dy;

                    // Keep within viewport bounds
                    const maxX = window.innerWidth - sidebar.offsetWidth - 10;
                    const maxY = window.innerHeight - sidebar.offsetHeight - 10;
                    newX = Math.max(10, Math.min(newX, maxX));
                    newY = Math.max(10, Math.min(newY, maxY));

                    sidebar.style.left = newX + 'px';
                    sidebar.style.top = newY + 'px';
                    sidebar.style.right = 'auto';
                });

                document.addEventListener('mouseup', function () {
                    if (isDragging) {
                        isDragging = false;
                        sidebar.style.transition = 'opacity 0.3s ease';
                        sidebar.style.cursor = '';
                        handle.style.cursor = 'grab';
                    }
                });
            })();
        </script>
        {{ end }}

        <article class="norm {{ if .TableOfContents }}has-toc{{ end }}">
            <h2 id="title">{{ .Title }}</h2>

            <div class="post-byline">
                <div class="author-avatar">{{ slicestr (.Params.author | default "Sudip") 0 1 | upper }}</div>
                <div class="byline-info">
                    <span class="authors">{{ .Params.author | default "Sudip" }}</span>
                    <time class="dt-published" datetime="{{ .Date.Format " 2006-01-02" }}">
                        {{ .Date.Format "January 2, 2006" }} · {{ math.Round (div (countwords .Content) 200.0) }} min
                        read
                    </time>
                </div>
            </div>

            <!-- Mobile TOC (Collapsible) -->
            {{ if .TableOfContents }}
            <details class="toc-container toc-mobile" open>
                <summary class="toc-header">
                    <span class="toc-icon">☰</span>
                    <span class="toc-title">Table of Contents</span>
                    <span class="toc-toggle">▼</span>
                </summary>
                <nav class="toc-nav">
                    {{ .TableOfContents }}
                </nav>
            </details>
            {{ end }}

            {{ .Content }}

            {{ if .Params.tags }}
            <p class="post-tags">
                {{ range .Params.tags }}
                <a class="hashtag" href="{{ "/tags/" | relLangURL }}{{ . | urlize }}">
                    <span>#</span><span>{{ . }}</span>
                </a>
                {{ end }}
            </p>
            {{ end }}
        </article>
    </div>
</div>

{{ partial "footer.html" . }}
