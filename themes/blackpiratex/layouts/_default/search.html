{{ partial "header.html" . }}

<div class="blog-hero">
    <h1>Search</h1>
    <p>Find articles, thoughts, and images.</p>
</div>

<div class="search-page-container">
    <div class="search-input-wrapper">
        <i data-lucide="search" width="18"></i>
        <input type="text" id="search-input" placeholder="Type to search..." autocomplete="off">
    </div>

    <div id="search-results"></div>
    
    <div id="no-results" style="display:none;">
        <i data-lucide="inbox" width="48"></i>
        <p>No results found. Try different keywords.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
    let fuse;
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    const noResultsDiv = document.getElementById('no-results');

    // Fetch and initialize Fuse.js
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            console.log('Search index loaded:', data.length, 'items');
            fuse = new Fuse(data, {
                keys: ['title', 'content', 'summary'],
                threshold: 0.3,
                ignoreLocation: true,
                minMatchCharLength: 2
            });
        })
        .catch(err => console.error("Error loading search index:", err));

    // Handle search input with debounce
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = e.target.value.trim();
            resultsContainer.innerHTML = '';
            
            if (query.length < 2) {
                noResultsDiv.style.display = 'none';
                return;
            }

            if (!fuse) {
                console.warn('Search index not ready yet');
                return;
            }

            const results = fuse.search(query);
            console.log('Search results for "' + query + '":', results.length);

            if (results.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
                displayResults(results);
            }
        }, 300);
    });

    function displayResults(results) {
        // Organize results by section
        const blogPosts = results.filter(r => r.item.section === 'blog').map(r => r.item);
        const thoughts = results.filter(r => r.item.section === 'thoughts').map(r => r.item);
        const gallery = results.filter(r => r.item.section === 'gallery').map(r => r.item);

        let html = '';

        // Blog Posts Section
        if (blogPosts.length > 0) {
            html += '<div class="search-section">';
            html += '<h2 class="section-title">ğŸ“ Blog Posts</h2>';
            blogPosts.forEach(item => {
                const date = new Date(item.date).toLocaleDateString("en-US", { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const excerpt = (item.summary || item.content || '').substring(0, 150);
                html += `
                    <a href="${item.permalink}" class="blog-result">
                        <h3>${item.title}</h3>
                        <div class="blog-meta">ğŸ“… ${date}</div>
                        <p>${excerpt}${excerpt.length === 150 ? '...' : ''}</p>
                    </a>
                `;
            });
            html += '</div>';
        }

        // Thoughts Section
        if (thoughts.length > 0) {
            html += '<div class="search-section">';
            html += '<h2 class="section-title">ğŸ’­ Thoughts</h2>';
            html += '<div class="thoughts-grid">';
            thoughts.forEach(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString("en-US", { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const timeStr = date.toLocaleTimeString("en-US", { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const content = (item.content || item.summary || '').substring(0, 180);
                html += `
                    <a href="${item.permalink}" class="thought-result">
                        <div class="thought-meta">
                            <span class="thought-date">ğŸ“… ${dateStr}</span>
                            <span class="thought-time">ğŸ• ${timeStr}</span>
                        </div>
                        <div class="thought-content">${content}${content.length === 180 ? '...' : ''}</div>
                    </a>
                `;
            });
            html += '</div></div>';
        }

        // Gallery Section
        if (gallery.length > 0) {
            html += '<div class="search-section">';
            html += '<h2 class="section-title">ğŸ–¼ï¸ Gallery</h2>';
            html += '<div class="gallery-grid">';
            gallery.forEach(item => {
                html += `
                    <a href="${item.permalink}" class="gallery-result">
                        ${item.image ? `<img src="${item.image}" alt="${item.title || 'Gallery'}">` : '<div class="no-image">ğŸ“· No Image</div>'}
                        <div class="gallery-overlay">${item.title}</div>
                    </a>
                `;
            });
            html += '</div></div>';
        }

        resultsContainer.innerHTML = html;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
</script>

{{ partial "footer.html" . }}