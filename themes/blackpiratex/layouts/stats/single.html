{{ partial "header.html" . }}

{{ $blogPosts := where .Site.RegularPages "Section" "blog" }}
{{ $thoughtPosts := where .Site.RegularPages "Section" "thoughts" }}
{{ $galleryPosts := where .Site.RegularPages "Section" "gallery" }}

{{ $allContent := slice }}
{{ range $blogPosts }}{{ $allContent = $allContent | append . }}{{ end }}
{{ range $thoughtPosts }}{{ $allContent = $allContent | append . }}{{ end }}
{{ range $galleryPosts }}{{ $allContent = $allContent | append . }}{{ end }}

{{ $blogYearCounts := dict }}
{{ $blogYearWords := dict }}
{{ $blogWordTotal := 0 }}
{{ range $blogPosts }}
    {{ $year := .Date.Format "2006" }}
    {{ $count := default 0 (index $blogYearCounts $year) }}
    {{ $blogYearCounts = merge $blogYearCounts (dict $year (add $count 1)) }}
    {{ $wordCount := default 0 (index $blogYearWords $year) }}
    {{ $blogYearWords = merge $blogYearWords (dict $year (add $wordCount .WordCount)) }}
    {{ $blogWordTotal = add $blogWordTotal .WordCount }}
{{ end }}

{{ $thoughtYearCounts := dict }}
{{ $thoughtYearWords := dict }}
{{ $thoughtWordTotal := 0 }}
{{ range $thoughtPosts }}
    {{ $year := .Date.Format "2006" }}
    {{ $count := default 0 (index $thoughtYearCounts $year) }}
    {{ $thoughtYearCounts = merge $thoughtYearCounts (dict $year (add $count 1)) }}
    {{ $wordCount := default 0 (index $thoughtYearWords $year) }}
    {{ $thoughtYearWords = merge $thoughtYearWords (dict $year (add $wordCount .WordCount)) }}
    {{ $thoughtWordTotal = add $thoughtWordTotal .WordCount }}
{{ end }}

{{ $galleryYearCounts := dict }}
{{ range $galleryPosts }}
    {{ $year := .Date.Format "2006" }}
    {{ $count := default 0 (index $galleryYearCounts $year) }}
    {{ $galleryYearCounts = merge $galleryYearCounts (dict $year (add $count 1)) }}
{{ end }}

{{ $yearsMap := dict }}
{{ range $allContent }}
    {{ $year := .Date.Format "2006" }}
    {{ $yearsMap = merge $yearsMap (dict $year true) }}
{{ end }}

{{ $years := slice }}
{{ range $year, $_ := $yearsMap }}
    {{ $years = $years | append $year }}
{{ end }}
{{ $years = sort $years }}

{{ $monthCounts := dict }}
{{ range $allContent }}
    {{ $month := .Date.Format "01" }}
    {{ $count := default 0 (index $monthCounts $month) }}
    {{ $monthCounts = merge $monthCounts (dict $month (add $count 1)) }}
{{ end }}

{{ $monthLabels := slice "Jan" "Feb" "Mar" "Apr" "May" "Jun" "Jul" "Aug" "Sep" "Oct" "Nov" "Dec" }}
{{ $monthKeys := slice "01" "02" "03" "04" "05" "06" "07" "08" "09" "10" "11" "12" }}

{{ $scratch := newScratch }}
{{ $scratch.Set "blogCounts" (slice) }}
{{ $scratch.Set "thoughtCounts" (slice) }}
{{ $scratch.Set "galleryCounts" (slice) }}
{{ $scratch.Set "totalCounts" (slice) }}
{{ $scratch.Set "blogWordCounts" (slice) }}
{{ $scratch.Set "thoughtWordCounts" (slice) }}
{{ range $years }}
    {{ $blogCount := default 0 (index $blogYearCounts .) }}
    {{ $thoughtCount := default 0 (index $thoughtYearCounts .) }}
    {{ $galleryCount := default 0 (index $galleryYearCounts .) }}
    {{ $totalCount := add (add $blogCount $thoughtCount) $galleryCount }}
    {{ $blogWordCount := default 0 (index $blogYearWords .) }}
    {{ $thoughtWordCount := default 0 (index $thoughtYearWords .) }}
    {{ $scratch.Add "blogCounts" $blogCount }}
    {{ $scratch.Add "thoughtCounts" $thoughtCount }}
    {{ $scratch.Add "galleryCounts" $galleryCount }}
    {{ $scratch.Add "totalCounts" $totalCount }}
    {{ $scratch.Add "blogWordCounts" $blogWordCount }}
    {{ $scratch.Add "thoughtWordCounts" $thoughtWordCount }}
{{ end }}

{{ $scratch.Set "monthCounts" (slice) }}
{{ range $monthKeys }}
    {{ $count := default 0 (index $monthCounts .) }}
    {{ $scratch.Add "monthCounts" $count }}
{{ end }}

{{ $totalItems := add (add (len $blogPosts) (len $thoughtPosts)) (len $galleryPosts) }}

<div id="post">
    <div id="wrapper">
        <article class="norm writeas-stats">
            <h2 id="title">Site Stats</h2>
            <p class="thoughts-meta">Signals from the blog, thoughts, and gallery archives.</p>

            <div class="writeas-stat-grid">
                <div class="writeas-stat-card">
                    <span class="writeas-stat-label">Total items</span>
                    <span class="writeas-stat-value">{{ $totalItems }}</span>
                </div>
                <div class="writeas-stat-card">
                    <span class="writeas-stat-label">Blog posts</span>
                    <span class="writeas-stat-value">{{ len $blogPosts }}</span>
                </div>
                <div class="writeas-stat-card">
                    <span class="writeas-stat-label">Thoughts</span>
                    <span class="writeas-stat-value">{{ len $thoughtPosts }}</span>
                </div>
                <div class="writeas-stat-card">
                    <span class="writeas-stat-label">Gallery shots</span>
                    <span class="writeas-stat-value">{{ len $galleryPosts }}</span>
                </div>
                <div class="writeas-stat-card">
                    <span class="writeas-stat-label">Years tracked</span>
                    <span class="writeas-stat-value">{{ len $years }}</span>
                </div>
            </div>

            <div class="writeas-chart-grid">
                <div class="writeas-chart-card">
                    <h3 class="writeas-section-title">Content mix</h3>
                    <canvas id="typeChart" height="220"></canvas>
                </div>
                <div class="writeas-chart-card">
                    <h3 class="writeas-section-title">Yearly output</h3>
                    <canvas id="yearChart" height="220"></canvas>
                </div>
                <div class="writeas-chart-card">
                    <h3 class="writeas-section-title">Monthly rhythm</h3>
                    <canvas id="monthChart" height="220"></canvas>
                </div>
            </div>

            <section class="writeas-section">
                <h3 class="writeas-section-title">Blog Deep Dive</h3>
                <div class="writeas-stat-grid writeas-stat-grid--compact">
                    <div class="writeas-stat-card">
                        <span class="writeas-stat-label">Total posts</span>
                        <span class="writeas-stat-value">{{ len $blogPosts }}</span>
                    </div>
                    <div class="writeas-stat-card">
                        <span class="writeas-stat-label">Total words</span>
                        <span class="writeas-stat-value">{{ $blogWordTotal }}</span>
                    </div>
                </div>
                <div class="writeas-chart-grid writeas-chart-grid--two">
                    <div class="writeas-chart-card">
                        <h3 class="writeas-section-title">Posts per year</h3>
                        <canvas id="blogYearChart" height="220"></canvas>
                    </div>
                    <div class="writeas-chart-card">
                        <h3 class="writeas-section-title">Words per year</h3>
                        <canvas id="blogWordChart" height="220"></canvas>
                    </div>
                </div>
            </section>

            <section class="writeas-section">
                <h3 class="writeas-section-title">Thoughts Deep Dive</h3>
                <div class="writeas-stat-grid writeas-stat-grid--compact">
                    <div class="writeas-stat-card">
                        <span class="writeas-stat-label">Total thoughts</span>
                        <span class="writeas-stat-value">{{ len $thoughtPosts }}</span>
                    </div>
                    <div class="writeas-stat-card">
                        <span class="writeas-stat-label">Total words</span>
                        <span class="writeas-stat-value">{{ $thoughtWordTotal }}</span>
                    </div>
                </div>
                <div class="writeas-chart-grid writeas-chart-grid--two">
                    <div class="writeas-chart-card">
                        <h3 class="writeas-section-title">Thoughts per year</h3>
                        <canvas id="thoughtYearChart" height="220"></canvas>
                    </div>
                    <div class="writeas-chart-card">
                        <h3 class="writeas-section-title">Words per year</h3>
                        <canvas id="thoughtWordChart" height="220"></canvas>
                    </div>
                </div>
            </section>
        </article>
    </div>
</div>

<script src="{{ "js/vendor/chart.umd.min.js" | relURL }}"></script>
<script>
    const statsData = {{ dict
        "years" $years
        "blogCounts" ($scratch.Get "blogCounts")
        "thoughtCounts" ($scratch.Get "thoughtCounts")
        "galleryCounts" ($scratch.Get "galleryCounts")
        "totalCounts" ($scratch.Get "totalCounts")
        "blogWordCounts" ($scratch.Get "blogWordCounts")
        "thoughtWordCounts" ($scratch.Get "thoughtWordCounts")
        "monthLabels" $monthLabels
        "monthCounts" ($scratch.Get "monthCounts")
    | jsonify | safeJS }};

    let charts = [];

    const buildCharts = () => {
        charts.forEach((chart) => chart.destroy());
        charts = [];

        const rootStyles = getComputedStyle(document.documentElement);
        const palette = {
            ink: rootStyles.getPropertyValue("--primary-blue").trim() || "#0000AA",
            sky: rootStyles.getPropertyValue("--chart-sky").trim() || "#5f9cff",
            sun: rootStyles.getPropertyValue("--chart-sun").trim() || "#ffd44d",
            moss: rootStyles.getPropertyValue("--chart-moss").trim() || "#4caf82",
            haze: rootStyles.getPropertyValue("--chart-haze").trim() || "#f3f6ff"
        };

        const chartDefaults = {
            font: {
                family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif",
                size: 12
            },
            color: rootStyles.getPropertyValue("--text-main").trim() || "#333"
        };

        charts.push(new Chart(document.getElementById("typeChart"), {
            type: "doughnut",
            data: {
                labels: ["Blog", "Thoughts", "Gallery"],
                datasets: [{
                    data: [
                        statsData.blogCounts.reduce((a, b) => a + b, 0),
                        statsData.thoughtCounts.reduce((a, b) => a + b, 0),
                        statsData.galleryCounts.reduce((a, b) => a + b, 0)
                    ],
                    backgroundColor: [palette.ink, palette.sky, palette.sun],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: { position: "bottom", labels: chartDefaults }
                },
                cutout: "65%"
            }
        }));

        charts.push(new Chart(document.getElementById("yearChart"), {
            type: "bar",
            data: {
                labels: statsData.years,
                datasets: [
                    {
                        label: "Blog",
                        data: statsData.blogCounts,
                        backgroundColor: palette.ink,
                        borderRadius: 6
                    },
                    {
                        label: "Thoughts",
                        data: statsData.thoughtCounts,
                        backgroundColor: palette.sky,
                        borderRadius: 6
                    },
                    {
                        label: "Gallery",
                        data: statsData.galleryCounts,
                        backgroundColor: palette.sun,
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true, ticks: chartDefaults },
                    y: { stacked: true, ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { position: "bottom", labels: chartDefaults },
                    tooltip: { mode: "index", intersect: false }
                }
            }
        }));

        charts.push(new Chart(document.getElementById("monthChart"), {
            type: "line",
            data: {
                labels: statsData.monthLabels,
                datasets: [{
                    label: "Total items",
                    data: statsData.monthCounts,
                    borderColor: palette.moss,
                    backgroundColor: "rgba(76, 175, 130, 0.2)",
                    tension: 0.35,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: palette.moss
                }]
            },
            options: {
                scales: {
                    x: { ticks: chartDefaults },
                    y: { ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        }));

        charts.push(new Chart(document.getElementById("blogYearChart"), {
            type: "bar",
            data: {
                labels: statsData.years,
                datasets: [{
                    label: "Posts",
                    data: statsData.blogCounts,
                    backgroundColor: palette.ink,
                    borderRadius: 6
                }]
            },
            options: {
                scales: {
                    x: { ticks: chartDefaults },
                    y: { ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        }));

        charts.push(new Chart(document.getElementById("blogWordChart"), {
            type: "line",
            data: {
                labels: statsData.years,
                datasets: [{
                    label: "Words",
                    data: statsData.blogWordCounts,
                    borderColor: palette.sky,
                    backgroundColor: "rgba(95, 156, 255, 0.2)",
                    tension: 0.35,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: palette.sky
                }]
            },
            options: {
                scales: {
                    x: { ticks: chartDefaults },
                    y: { ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        }));

        charts.push(new Chart(document.getElementById("thoughtYearChart"), {
            type: "bar",
            data: {
                labels: statsData.years,
                datasets: [{
                    label: "Thoughts",
                    data: statsData.thoughtCounts,
                    backgroundColor: palette.sun,
                    borderRadius: 6
                }]
            },
            options: {
                scales: {
                    x: { ticks: chartDefaults },
                    y: { ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        }));

        charts.push(new Chart(document.getElementById("thoughtWordChart"), {
            type: "line",
            data: {
                labels: statsData.years,
                datasets: [{
                    label: "Words",
                    data: statsData.thoughtWordCounts,
                    borderColor: palette.moss,
                    backgroundColor: "rgba(76, 175, 130, 0.2)",
                    tension: 0.35,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: palette.moss
                }]
            },
            options: {
                scales: {
                    x: { ticks: chartDefaults },
                    y: { ticks: chartDefaults, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        }));
    };

    buildCharts();

    if (typeof MutationObserver !== "undefined") {
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === "attributes" && mutation.attributeName === "data-theme") {
                    buildCharts();
                }
            }
        });
        observer.observe(document.documentElement, { attributes: true });
    }

</script>

{{ partial "footer.html" . }}
